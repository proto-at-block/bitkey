package build.wallet.gradle.logic.reproducible

import org.gradle.api.DefaultTask
import org.gradle.api.file.ConfigurableFileCollection
import org.gradle.api.file.RegularFileProperty
import org.gradle.api.provider.Property
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.OutputDirectories
import org.gradle.api.tasks.OutputFile
import org.gradle.api.tasks.TaskAction
import org.intellij.lang.annotations.Language

abstract class GenerateEmergencyAccessKitInformationTask : DefaultTask() {
  @get:Input
  abstract val apkVersion: Property<String>

  @get:Input
  abstract val apkHash: Property<String>

  @get:Input
  abstract val apkUrl: Property<String>

  @get:OutputFile
  abstract val outputFile: RegularFileProperty

  @get:OutputDirectories
  abstract val outputDirectories: ConfigurableFileCollection

  init {
    group = "reproducible"
    description = "Generates the Emergency Exit Kit app information for the Emergency Exit Kit PDF"
  }

  @TaskAction
  fun generateEmergencyAccessKitInformation() {
    val apkVersion = apkVersion.get()
    val apkHash = apkHash.get()
    val apkUrl = apkUrl.get()

    @Language("kotlin")
    val emergencyAccessKitAppInformation = """
      |package build.wallet.emergencyaccesskit
      |
      |/**
      | * DO NOT EDIT THIS FILE. IT IS GENERATED AS PART OF THE BUILD AND RELEASE PROCESS.
      | *
      | * The Emergency Exit Kit app version, hash, and URL that is associated with the current release.
      | * Inserted into the Emergency Exit Kit PDF when it is generated.
      | *
      | * The release process will build the EEK version of the app, then update this file with the
      | * version number, hash, and URL where it is hosted.
      | *
      | * See [Emergency Exit Kit Engineering Design - Release Pipeline](https://docs.google.com/document/d/1frmVxpUnbswWBJRh57u7GiUL_enHUV3wgHckR49q50E/edit#heading=h.klvvm1l9wksq)
      | */
      |data object EmergencyAccessKitAppInformation {
      |  /** Version number of the Emergency Exit Kit app */
      |  const val ApkVersion: String = "$apkVersion"
      |  /** SHA-256 of built Apk */
      |  const val ApkHash: String = "$apkHash"
      |  /** URL to the location where the Emergency Exit Kit app is hosted */
      |  const val ApkUrl: String = "$apkUrl"
      |}
    """.trimMargin()
    outputFile.asFile.get().writeText(emergencyAccessKitAppInformation)
  }
}
