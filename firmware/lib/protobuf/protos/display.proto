syntax = "proto3";

package fwpb;

import "nanopb.proto";

// Display transitions
enum display_transition {
  DISPLAY_TRANSITION_NONE = 0;
  DISPLAY_TRANSITION_SLIDE_LEFT = 1;
  DISPLAY_TRANSITION_SLIDE_RIGHT = 2;
  DISPLAY_TRANSITION_SLIDE_UP = 3;
  DISPLAY_TRANSITION_SLIDE_DOWN = 4;
  DISPLAY_TRANSITION_FADE = 5;
}

// Menu items
enum display_menu_item {
  DISPLAY_MENU_ITEM_BACK = 0;
  DISPLAY_MENU_ITEM_FINGERPRINTS = 1;
  DISPLAY_MENU_ITEM_BRIGHTNESS = 2;
  DISPLAY_MENU_ITEM_ABOUT = 3;
  DISPLAY_MENU_ITEM_REGULATORY = 4;
  DISPLAY_MENU_ITEM_LOCK_DEVICE = 5;
  DISPLAY_MENU_ITEM_POWER_OFF = 6;
  DISPLAY_MENU_ITEM_TOUCH_TEST = 7;
  DISPLAY_MENU_ITEM_TOGGLE_SLEEP = 8;
  DISPLAY_MENU_ITEM_RUN_IN = 9;
}

// Display result codes
enum display_result {
  DISPLAY_RESULT_SUCCESS = 0;
  DISPLAY_RESULT_ERROR = 1;
  DISPLAY_RESULT_NOT_INITIALIZED = 2;
  DISPLAY_RESULT_INVALID_PARAM = 3;
}

// Display flags
enum display_flag {
  DISPLAY_FLAG_NONE = 0;        // No flags set (default)
  DISPLAY_FLAG_ROTATE_180 = 1;  // Bit 0: Rotate display 180 degrees
}

message display_params_empty {
}

message display_params_menu {
  bool sleep_disabled = 1;  // MFG only: true if sleep timer is inhibited
  uint32 selected_item = 2;     // Which menu item should be selected
}

message display_params_about {
  string firmware_version = 1 [(nanopb).max_size = 32];
  string hardware_version = 2 [(nanopb).max_size = 32];
  string serial_number = 3 [(nanopb).max_size = 32];
}

enum display_mfg_test_mode {
  DISPLAY_MFG_TEST_MODE_ANIMATION = 0;
  DISPLAY_MFG_TEST_MODE_NFC_TEST = 1;
  DISPLAY_MFG_TEST_MODE_START_SCREEN = 2;
  reserved 3;  // Was TOUCH_PROMPT - removed
  DISPLAY_MFG_TEST_MODE_COUNTDOWN = 4;
  DISPLAY_MFG_TEST_MODE_STATUS = 5;
  DISPLAY_MFG_TEST_MODE_BURNIN_GRID = 6;
  DISPLAY_MFG_TEST_MODE_BUTTON_BYPASS_WARNING = 7;
  DISPLAY_MFG_TEST_MODE_COLOR_BARS = 8;
  DISPLAY_MFG_TEST_MODE_SCROLLING_H = 9;
  DISPLAY_MFG_TEST_MODE_CUSTOM_COLOR = 10;
  DISPLAY_MFG_TEST_MODE_TOUCH_TEST_BOXES = 11;
}

message display_params_mfg {
  display_mfg_test_mode test_mode = 1;
  uint32 initial_soc = 2;
  uint32 battery_percent = 3;
  bool is_charging = 4;
  uint32 loop_count = 5;
  uint32 elapsed_ms = 6;
  bool plugged_in = 7;
  uint32 button_events = 8;
  uint32 captouch_events = 9;
  uint32 display_touch_events = 10;
  uint32 fingerprint_events = 11;
  uint32 countdown_value = 12;
  uint32 power_phase = 13;           // 0=charge1, 1=discharge, 2=charge2, 3=complete
  bool has_failures = 14;
  bool test_complete = 15;
  uint32 custom_rgb = 16;            // RGB color as 0xRRGGBB for CUSTOM_COLOR mode
  uint32 brightness_percent = 17;    // Brightness (0 = don't change, 1-100 = set percent)
  uint32 phase_time_remaining_ms = 18;  // Time remaining in current power phase
  bool target_reached = 19;          // True if SOC target reached (holding)
}

message display_params_money_movement {
  // Current step in the money movement flow.
  enum display_params_money_movement_step {
    // Unused.
    NONE = 0;

    // Displaying the address.
    ADDRESS = 1;

    // Displaying the amount.
    AMOUNT = 2;

    // Confirming the amount.
    CONFIRM = 3;
  }

  string amount_sats = 1 [(nanopb).max_size = 32];
  string fee_sats = 2 [(nanopb).max_size = 32];
  string address = 3 [(nanopb).max_size = 256];
  bool is_receive_flow = 4;
}

message display_params_success {
  enum display_params_success_status {
    // Unused.
    NONE = 0;

    // Firmware update successfully.
    FIRMWARE_UPDATED = 1;
  }

  // Operation status code.
  display_params_success_status status = 1;
}

message display_params_error {
  enum display_params_error_status {
    // Unused.
    NONE = 0;

    // Firmware update failed.
    FIRMWARE_UPDATE_FAILED = 1;
  }

  // Operation status code.
  display_params_error_status status = 1;
}

message display_params_scan {
  // Possible actions to take on scanning.
  enum display_params_scan_action {
    // No action.
    NONE = 0;

    // Scan to sign transaction.
    SIGN = 1;

    // Scan to get information in order to verify.
    VERIFY = 2;

    // Confirm action by scanning.
    CONFIRM = 3;

    // Tap phone to device.
    TAP = 4;
  }

  // Action to take on scanning.
  display_params_scan_action action = 1;
}

message display_params_fingerprint {
  // Status code of the enrollment action.
  enum display_params_fingerprint_status {
    // No enrollment in progress.
    NONE = 0;

    // Enrollment started.
    ENROLL_FIRST = 1;

    // Repeat lifting and placing finger.
    ENROLL_REPEAT = 2;

    // Try to lift and place again.
    ENROLL_TRY_AGAIN = 3;

    // Enrollment failed.
    ENROLL_FAILED = 4;
  }

  display_params_fingerprint_status status = 1;
  uint32 progress_percent = 2;
  uint32 samples_remaining = 3;
  bool is_required = 4;  // True if enrollment is required (onboarding), false if optional (from menu)
}

message display_params_locked {
  uint32 battery_percent = 1;
  bool is_charging = 2;
  bool show_unlocked = 3;
}

message display_params_menu_fingerprints {
  repeated bool enrolled = 1 [(nanopb).max_count = 3];
  repeated string labels = 2 [(nanopb).max_count = 3, (nanopb).max_size = 32];
  uint32 authenticated_index = 3;  // Which fingerprint was authenticated (0-2)
  bool show_authenticated = 4;     // Trigger authentication animation (one-shot, like bounce)
  uint32 initial_slot = 5;         // Initial scroll position (0-2)
}

message display_params_firmware_update {
  string hash = 1 [(nanopb).max_size = 65];
  string version = 2 [(nanopb).max_size = 32];
}

// Privileged action types
enum display_privileged_action_type {
  DISPLAY_PRIVILEGED_ACTION_NONE = 0;
  DISPLAY_PRIVILEGED_ACTION_WIPE_DEVICE = 1;
}

// Confirm an address (uses address display widget with pagination)
message display_params_privileged_action_confirm_address {
  string address = 1 [(nanopb).max_size = 128];
}

// Confirm a string value
message display_params_privileged_action_confirm_string {
  string value = 1 [(nanopb).max_size = 128];
}

// Firmware update confirmation
message display_params_privileged_action_fwup {
  string hash = 1 [(nanopb).max_size = 65];  // SHA256 hex string
  string version = 2 [(nanopb).max_size = 32]; // Semantic version
}

// Confirm action (e.g., wipe device)
message display_params_privileged_action_confirm_action {
  display_privileged_action_type action_type = 1;
}

// Main privileged action message
message display_params_privileged_action {
  string title = 1 [(nanopb).max_size = 32];

  oneof action {
    display_params_privileged_action_confirm_address confirm_address = 2;
    display_params_privileged_action_confirm_string confirm_string = 3;
    display_params_privileged_action_fwup fwup = 4;
    display_params_privileged_action_confirm_action confirm_action = 5;
  }
}

// Display show screen command
message display_show_screen {
  display_transition transition = 1;
  uint32 duration_ms = 2;
  uint32 brightness_percent = 3;  // Display brightness (0-100)
  uint32 flags = 4;  // Bitfield: bit 0 = rotate 180 degrees

  oneof params {
    display_params_menu menu = 5;
    display_params_about about = 6;
    display_params_empty brightness = 7;
    display_params_empty regulatory = 8;
    display_params_mfg mfg = 9;
    display_params_money_movement money_movement = 10;
    display_params_empty onboarding = 11;
    display_params_success success = 12;
    display_params_error error = 13;
    display_params_scan scan = 14;
    display_params_fingerprint fingerprint = 15;
    display_params_locked locked = 16;
    display_params_menu_fingerprints menu_fingerprints = 17;
    display_params_firmware_update firmware_update = 19;
    display_params_empty test_gesture = 20;
    display_params_empty test_scroll = 21;
    display_params_empty test_pin_pad = 22;
    display_params_empty test_carousel = 23;
    display_params_empty test_slider = 24;
    display_params_empty test_progress = 25;
    display_params_privileged_action privileged_action = 26;
  }
}

// Prepare sleep command
message display_prepare_sleep {
  // No parameters needed
}

// Main display command message
message display_command {
  oneof command {
    display_show_screen show_screen = 1;
    display_prepare_sleep prepare_sleep = 2;
  }
}

// Touch screen event.
message display_touch {

  // Type of touch event or gesture.
  enum display_touch_event {
    // Single tap touch event.
    DISPLAY_TOUCH_EVENT_TOUCH = 0;

    // Swipe left gesture.
    DISPLAY_TOUCH_EVENT_GESTURE_SWIPE_LEFT = 1;

    // Swipe right gesture.
    DISPLAY_TOUCH_EVENT_GESTURE_SWIPE_RIGHT = 2;

    // Swipe up gesture.
    DISPLAY_TOUCH_EVENT_GESTURE_SWIPE_UP = 3;

    // Swipe down gesture.
    DISPLAY_TOUCH_EVENT_GESTURE_SWIPE_DOWN = 4;

    // Double tap gesture.
    DISPLAY_TOUCH_EVENT_GESTURE_DOUBLE_TAP = 5;

    // Triple tap gesture.
    DISPLAY_TOUCH_EVENT_GESTURE_TRIPLE_TAP = 6;

    // Long press gesture.
    DISPLAY_TOUCH_EVENT_GESTURE_LONG_PRESS = 7;
  };

  // Touch coordinates.
  message display_touch_coord {
    // X coordinate of the touch event or gesture.
    uint32 x = 1;

    // Y coordinate of the touch event or gesture.
    uint32 y = 2;
  };

  // Type of touch event or gesture.
  display_touch_event event = 1;

  // Touch event or gesture coordinates.
  display_touch_coord coord = 2;
}

// Touch test box status update (sent when boxes are cleared).
message display_mfg_touch_test_status {
  // Number of boxes remaining in the touch test.
  uint32 boxes_remaining = 1;
}

// Display action message.
message display_action {
  // Type of action or status update.
  enum display_action_type {
    DISPLAY_ACTION_NONE = 0;

    // Status updates
    DISPLAY_ACTION_READY = 1;              // Display subsystem ready to receive commands
    DISPLAY_ACTION_SLEEP_READY = 2;        // Display ready for sleep (touch monitor mode active)

    // Universal flow actions
    DISPLAY_ACTION_APPROVE = 3;            // Approve/confirm current flow
    DISPLAY_ACTION_CANCEL = 4;             // Cancel current flow
    DISPLAY_ACTION_BACK = 5;               // Go back one step
    DISPLAY_ACTION_EXIT = 6;               // Exit current flow entirely
    DISPLAY_ACTION_MENU = 7;               // Navigate to main menu

    // Specific flow actions
    DISPLAY_ACTION_LOCK_DEVICE = 8;        // Lock the device
    DISPLAY_ACTION_POWER_OFF = 9;          // Power off device
    DISPLAY_ACTION_START_ENROLLMENT = 10;  // Start fingerprint enrollment
    DISPLAY_ACTION_DELETE_FINGERPRINT = 11;// Delete fingerprint
  }

  // The action type.
  display_action_type action = 1;

  // Optional action-specific data (e.g., fingerprint index, menu item, brightness value).
  uint32 data = 2;
}
