#!/bin/bash
set -euo pipefail

# Wrapper for production environment
# Usage: tf-production plan|apply|destroy [terraform args...]
# WARNING: Production deployments should go through Atlantis in PRs

echo "⚠️  WARNING: You are about to run terraform against PRODUCTION"
echo "Production changes should normally go through Atlantis (atlantis plan/apply in PRs)"
read -p "Are you sure you want to proceed? (yes/no): " -r
if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
    echo "Aborted."
    exit 1
fi

BACKEND="tfvars/production/backends.tfvars"
VARFILE="tfvars/production/production.tfvars"

# Set AWS environment
export AWS_PROFILE=bitkey-fw-signer-production--admin
export AWS_REGION=us-west-2

# Safety: Always re-init to ensure correct backend
echo "Initializing with production backend"
terraform init -reconfigure -backend-config="$BACKEND" > /dev/null

# Run terraform with correct var files and is_localstack flag
exec terraform "$@" -var-file="$VARFILE" -var-file="$BACKEND" -var="is_localstack=false"
